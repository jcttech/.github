name: Claude PR Review

on:
  workflow_call:
    inputs:
      model:
        type: string
        default: 'claude-opus-4-6'
        description: 'Claude model to use for review'
      max-turns:
        type: number
        default: 10
        description: 'Maximum conversation turns (controls cost)'
      timeout-minutes:
        type: number
        default: 15
        description: 'Maximum runtime in minutes'
      runner:
        type: string
        default: 'ubuntu-latest'
        description: 'GitHub Actions runner to use'
      review-extra:
        type: string
        default: ''
        description: 'Additional review instructions appended to the default prompt'

jobs:
  review:
    name: Claude Review
    runs-on: ${{ inputs.runner }}
    if: github.event.pull_request.draft == false
    timeout-minutes: ${{ inputs.timeout-minutes }}
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude PR Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ github.token }}
          use_sticky_comment: true
          claude_args: |
            --model ${{ inputs.model }}
            --max-turns ${{ inputs.max-turns }}
            --allowedTools "Read,Glob,Grep,Bash(git diff:*),Bash(git log:*),Bash(git show:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*)"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are reviewing PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.
            The PR branch is already checked out in the current working directory.

            ## How to Post Your Review

            IMPORTANT: You MUST post your review as GitHub comments. Do NOT just return text as messages.
            - Use `gh pr comment ${{ github.event.pull_request.number }}` for top-level review summary
            - Only post GitHub comments — don't submit review text as conversation messages

            ## Review Focus Areas

            1. **Code Quality**: Clean, readable, well-structured? Following project conventions?
            2. **Security**: Injection, XSS, exposed secrets, input validation?
            3. **Bugs**: Logic errors, race conditions, edge cases, resource leaks?
            4. **Performance**: Unnecessary allocations, N+1 queries, blocking in async?
            5. **Testing**: New paths covered? Edge cases tested? Meaningful assertions?

            ## Review Guidelines
            - ONLY comment on the changed code (the diff), not pre-existing issues
            - Rate each issue: CRITICAL / HIGH / MEDIUM / LOW
            - If the PR looks good, say so briefly — do not nitpick for the sake of it
            - Be constructive: suggest fixes, not just problems
            - Check CLAUDE.md for project-specific conventions

            ${{ inputs.review-extra }}
